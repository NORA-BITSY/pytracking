{% extends "base.html" %}

{% block title %}Dashboard - PyTracking{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Emails Sent -->
    <div class="bg-white rounded-xl shadow p-6 tracking-card transition-transform duration-200">
        <div class="flex items-center">
            <div class="bg-blue-100 p-3 rounded-lg">
                <i class="fas fa-paper-plane text-blue-500 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-500 text-sm">Total Emails Sent</p>
                <p class="text-2xl font-bold">{{ total_emails|default(0) }}</p>
            </div>
        </div>
        <div class="mt-4">
            <div class="flex justify-between text-sm text-gray-500">
                <span>+12.4% from last month</span>
                <span>Goal: {{ (total_emails|default(0) * 1.2)|round|int }}</span>
            </div>
            <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-500 h-2 rounded-full progress-bar" style="width: 85%"></div>
            </div>
        </div>
    </div>

    <!-- Open Rate -->
    <div class="bg-white rounded-xl shadow p-6 tracking-card transition-transform duration-200">
        <div class="flex items-center">
            <div class="bg-green-100 p-3 rounded-lg">
                <i class="fas fa-envelope-open text-green-500 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-500 text-sm">Open Rate</p>
                <p class="text-2xl font-bold">{{ "%.1f"|format((total_opens / total_emails * 100) if total_emails > 0 else 0) }}%</p>
            </div>
        </div>
        <div class="mt-4">
            <div class="flex justify-between text-sm text-gray-500">
                <span>+3.2% from last month</span>
                <span>Avg: 39.5%</span>
            </div>
            <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full progress-bar" style="width: {{ (total_opens / total_emails * 100) if total_emails > 0 else 0 }}%"></div>
            </div>
        </div>
    </div>

    <!-- Click Rate -->
    <div class="bg-white rounded-xl shadow p-6 tracking-card transition-transform duration-200">
        <div class="flex items-center">
            <div class="bg-purple-100 p-3 rounded-lg">
                <i class="fas fa-mouse-pointer text-purple-500 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-500 text-sm">Click Rate</p>
                <p class="text-2xl font-bold">{{ "%.1f"|format((total_clicks / total_emails * 100) if total_emails > 0 else 0) }}%</p>
            </div>
        </div>
        <div class="mt-4">
            <div class="flex justify-between text-sm text-gray-500">
                <span>+1.8% from last month</span>
                <span>Avg: 16.2%</span>
            </div>
            <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                <div class="bg-purple-500 h-2 rounded-full progress-bar" style="width: {{ (total_clicks / total_emails * 100) if total_emails > 0 else 0 }}%"></div>
            </div>
        </div>
    </div>

    <!-- Total Campaigns -->
    <div class="bg-white rounded-xl shadow p-6 tracking-card transition-transform duration-200">
        <div class="flex items-center">
            <div class="bg-yellow-100 p-3 rounded-lg">
                <i class="fas fa-bullhorn text-yellow-500 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-500 text-sm">Total Campaigns</p>
                <p class="text-2xl font-bold">{{ total_campaigns|default(0) }}</p>
            </div>
        </div>
        <div class="mt-4">
            <div class="flex justify-between text-sm text-gray-500">
                <span>+2 this month</span>
                <span>Active: {{ total_campaigns|default(0) }}</span>
            </div>
            <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                <div class="bg-yellow-500 h-2 rounded-full progress-bar" style="width: 75%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Open Rate Over Time -->
    <div class="bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold text-gray-800">Open Rate Over Time</h2>
            <div class="flex space-x-2">
                <button class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">7D</button>
                <button class="text-xs bg-blue-500 text-white px-3 py-1 rounded">30D</button>
                <button class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">90D</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="openRateChart"></canvas>
        </div>
    </div>

    <!-- Click Distribution -->
    <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-bold text-gray-800 mb-6">Event Distribution</h2>
        <div class="chart-container">
            <canvas id="eventDistributionChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Campaigns -->
<div class="bg-white rounded-xl shadow mb-8">
    <div class="p-6 border-b border-gray-200">
        <h2 class="text-lg font-bold text-gray-800">Recent Campaigns</h2>
    </div>
    <div class="overflow-x-auto">
        {% if recent_campaigns %}
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaign</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Emails</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Opens</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clicks</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for campaign in recent_campaigns %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-2 rounded-lg">
                                <i class="fas fa-bullhorn text-blue-500"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ campaign.name }}</div>
                                <div class="text-sm text-gray-500">{{ campaign.subject or 'No subject' }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ campaign.emails|length }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ campaign.events|selectattr('event_type', 'equalto', 'open')|list|length }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ campaign.events|selectattr('event_type', 'equalto', 'click')|list|length }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="{{ url_for('campaign_detail', campaign_id=campaign.id) }}" class="text-blue-600 hover:text-blue-900">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-bullhorn fa-3x text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No campaigns yet</h3>
            <p class="text-gray-500 mb-4">Create your first email campaign to start tracking opens and clicks.</p>
            <a href="{{ url_for('create_campaign') }}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-plus mr-2"></i>Create Campaign
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Configuration Preview -->
    <div class="bg-white rounded-xl shadow p-6 lg:col-span-2">
        <h2 class="text-lg font-bold text-gray-800 mb-6">Quick Configuration</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Open Tracking URL</label>
                <div class="flex">
                    <input type="text" value="http://localhost:5000/track/open/" readonly class="flex-1 border border-gray-300 rounded-l-lg px-4 py-2 bg-gray-50 text-gray-600">
                    <button class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-r-lg border border-l-0 border-gray-300" onclick="copyToClipboard('http://localhost:5000/track/open/')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Click Tracking URL</label>
                <div class="flex">
                    <input type="text" value="http://localhost:5000/track/click/" readonly class="flex-1 border border-gray-300 rounded-l-lg px-4 py-2 bg-gray-50 text-gray-600">
                    <button class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-r-lg border border-l-0 border-gray-300" onclick="copyToClipboard('http://localhost:5000/track/click/')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="pt-4">
                <a href="{{ url_for('configuration') }}" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                    View Full Configuration
                </a>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-bold text-gray-800 mb-6">Quick Actions</h2>
        <div class="space-y-4">
            <a href="{{ url_for('create_campaign') }}" class="w-full flex items-center justify-between bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-3 rounded-lg transition-colors">
                <span>Create Campaign</span>
                <i class="fas fa-arrow-right"></i>
            </a>
            <a href="{{ url_for('send_test_email') }}" class="w-full flex items-center justify-between bg-green-50 hover:bg-green-100 text-green-700 px-4 py-3 rounded-lg transition-colors">
                <span>Send Test Email</span>
                <i class="fas fa-arrow-right"></i>
            </a>
            <a href="{{ url_for('analytics') }}" class="w-full flex items-center justify-between bg-purple-50 hover:bg-purple-100 text-purple-700 px-4 py-3 rounded-lg transition-colors">
                <span>View Analytics</span>
                <i class="fas fa-arrow-right"></i>
            </a>
            <a href="{{ url_for('api_recent_events') }}" class="w-full flex items-center justify-between bg-yellow-50 hover:bg-yellow-100 text-yellow-700 px-4 py-3 rounded-lg transition-colors">
                <span>API Events</span>
                <i class="fas fa-arrow-right"></i>
            </a>
            
            <div class="pt-4">
                <h3 class="font-medium text-gray-700 mb-2">Documentation</h3>
                <a href="/USER_MANUAL.md" class="flex items-center text-blue-500 hover:text-blue-700 mb-2">
                    <i class="fas fa-book mr-2"></i> User Manual
                </a>
                <a href="{{ url_for('api_recent_events') }}" class="flex items-center text-blue-500 hover:text-blue-700 mb-2">
                    <i class="fas fa-code mr-2"></i> API Reference
                </a>
                <a href="https://github.com/NORA-BITSY/pytracking" class="flex items-center text-blue-500 hover:text-blue-700">
                    <i class="fab fa-github mr-2"></i> GitHub Repository
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Open Rate Chart
    const openRateCtx = document.getElementById('openRateChart').getContext('2d');
    const openRateChart = new Chart(openRateCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'Open Rate',
                data: [{{ (total_opens / total_emails * 100 * 0.8) if total_emails > 0 else 0 }}, 
                       {{ (total_opens / total_emails * 100 * 0.9) if total_emails > 0 else 0 }}, 
                       {{ (total_opens / total_emails * 100 * 1.1) if total_emails > 0 else 0 }}, 
                       {{ (total_opens / total_emails * 100) if total_emails > 0 else 0 }}],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                pointBackgroundColor: '#3b82f6',
                pointRadius: 4,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });

    // Event Distribution Chart
    const eventCtx = document.getElementById('eventDistributionChart').getContext('2d');
    const eventChart = new Chart(eventCtx, {
        type: 'doughnut',
        data: {
            labels: ['Opens', 'Clicks', 'Emails Sent'],
            datasets: [{
                data: [{{ total_opens }}, {{ total_clicks }}, {{ total_emails }}],
                backgroundColor: [
                    '#10b981',
                    '#8b5cf6',
                    '#3b82f6'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            },
            cutout: '70%'
        }
    });

    // Animate progress bars
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0';
        setTimeout(() => {
            bar.style.width = width;
        }, 300);
    });
});
</script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h2 class="mb-0">{{ total_campaigns }}</h2>
                    <p class="mb-0">Total Campaigns</p>
                </div>
                <div class="flex-shrink-0">
                    <i class="fas fa-bullhorn fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h2 class="mb-0">{{ total_emails }}</h2>
                    <p class="mb-0">Emails Sent</p>
                </div>
                <div class="flex-shrink-0">
                    <i class="fas fa-envelope fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h2 class="mb-0">{{ total_opens }}</h2>
                    <p class="mb-0">Email Opens</p>
                    <small>{{ "%.1f"|format((total_opens / total_emails * 100) if total_emails > 0 else 0) }}% open rate</small>
                </div>
                <div class="flex-shrink-0">
                    <i class="fas fa-envelope-open fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h2 class="mb-0">{{ total_clicks }}</h2>
                    <p class="mb-0">Link Clicks</p>
                    <small>{{ "%.1f"|format((total_clicks / total_emails * 100) if total_emails > 0 else 0) }}% click rate</small>
                </div>
                <div class="flex-shrink-0">
                    <i class="fas fa-mouse-pointer fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Campaigns -->
<div class="row mt-4">
    <div class="col-lg-8">
        <div class="chart-container">
            <h4><i class="fas fa-chart-line"></i> Activity Overview</h4>
            <canvas id="activityChart" height="100"></canvas>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="chart-container">
            <h4><i class="fas fa-list"></i> Recent Campaigns</h4>
            {% if recent_campaigns %}
                <div class="list-group list-group-flush">
                    {% for campaign in recent_campaigns %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ campaign.name }}</h6>
                            <small class="text-muted">{{ campaign.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        <a href="{{ url_for('campaign_detail', campaign_id=campaign.id) }}" class="btn btn-sm btn-outline-primary">
                            View
                        </a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No campaigns yet. <a href="{{ url_for('create_campaign') }}">Create your first campaign</a>.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <h4><i class="fas fa-clock"></i> Real-time Activity</h4>
            <div id="recentActivity">
                <p class="text-muted">Loading recent activity...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Sample chart for activity overview
const ctx = document.getElementById('activityChart').getContext('2d');
const activityChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Opens',
            data: [12, 19, 3, 5, 2, 3, 10],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }, {
            label: 'Clicks',
            data: [2, 3, 1, 2, 1, 1, 4],
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Load recent activity
function loadRecentActivity() {
    fetch('/api/events?limit=10')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recentActivity');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted">No recent activity</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Time</th><th>Type</th><th>Campaign</th><th>IP</th></tr></thead><tbody>';
            
            data.forEach(event => {
                const time = new Date(event.timestamp).toLocaleString();
                const icon = event.type === 'open' ? '<i class="fas fa-envelope-open text-info"></i>' : '<i class="fas fa-mouse-pointer text-success"></i>';
                html += `<tr>
                    <td>${time}</td>
                    <td>${icon} ${event.type}</td>
                    <td>Campaign ${event.campaign_id}</td>
                    <td><small>${event.user_ip || 'N/A'}</small></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading recent activity:', error);
            document.getElementById('recentActivity').innerHTML = '<p class="text-danger">Error loading activity</p>';
        });
}

// Load activity on page load and refresh every 30 seconds
loadRecentActivity();
setInterval(loadRecentActivity, 30000);
</script>
{% endblock %}
